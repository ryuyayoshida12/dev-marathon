<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>詳細情報画面</title>
    <!-- Bootstrap CSSの読み込み -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
            <!-- ここにHTMLを書く -->

        <h2 class="mb-4">詳細情報画面</h2>
        <form id="customer-detail">
            <div class="form-group">
                <table class="table table-striped">
                    <thead class="thead-dark">
                        <tr>
                            <th scope="col">項目</th>
                            <th scope="col">顧客情報</th>   
                        </tr>
                    </thead>
                    <tbody>
                        <!-- javascriptでデータ差し込み -->
                        <tr>
                            <th>id</th>
                            <td id="customer_id"></td>
                        </tr>
                        <tr>
                            <th>会社名</th>
                            <td id="company"></td>
                        </tr>
                        <tr>
                            <th>業界</th>
                            <td id="industry"></td>
                        </tr>
                        <tr>
                            <th>電話番号</th>
                            <td id="contact"></td>
                        </tr>
                        <tr>
                            <th>所在地</th>
                            <td id="location"></td>
                        </tr>
                        <tr>
                            <th>登録日</th>
                            <td id="created_date"></td>
                        </tr>
                                                <tr>
                            <th>最終更新日</th>
                            <td id="updated_date"></td>
                        </tr>
                    </tbody>
                </table>
                <div style="text-align: right;">
                    <button type="button" class="btn btn-info" id="update">編集</button>
                    <button type="button" class="btn btn-danger" id="delete">削除</button>
                </div><br>
                <div style="text-align: right;">
                    <a href = "http://localhost/customer/list.html" >顧客一覧はこちら</a>
                </div>
            </div>
        </form>
    </div>

    <!-- CSS -->
    <style>
        th, td{
            text-align: center;       /* 横中央 */
            vertical-align: middle;   /* 縦中央 */
        }
    </style>  

    <!-- javascript -->
    <script type="module">
        import config from '../config.js';

        const queryParam = window.location.search; //urlからクエリパラメータ取得(?id=〇〇)
        const UrlParam = new URLSearchParams(queryParam); //URLsearchParams形式に(id=〇〇)
        const id = UrlParam.get("id"); //'id'の値を取得(〇〇)

        //------------- 初期画面構築 --------------
        // '/customer/{customerId}'にリクエスト
        fetch(`${config.apiUrl}/customer/${id}`, {
            method: "GET",
            headers: {
                "Accept": "application/json"
            }
        }).then(response => response.json())
          .then(jsonData => {

            //一旦変数に代入
            const {
                customer_id,
                company_name, 
                industry, 
                contact, 
                location, 
                created_date, 
                updated_date
            }   = jsonData;

            //htmlにデータ差し込み
            document.getElementById("customer_id").textContent = customer_id;
            document.getElementById("company").textContent = company_name;
            document.getElementById("industry").textContent = industry;
            document.getElementById("contact").textContent = contact;
            document.getElementById("location").textContent = location;

            //日付関係は整形してから差し込み
            [
                {id: "created_date", date: created_date},
                {id: "updated_date", date: updated_date}
            ].forEach(({id, date}) => {
                document.getElementById(id).textContent = date.slice(0, 10);
            });
          })
          .catch((error) => console.error(error));

        //----------- 編集ボタン押下時 ------------
        document.getElementById("update").addEventListener("click", function(e) {
            e.preventDefault();

            window.location.href = `update.html${queryParam}`;
        })

        //----------- 削除ボタン押下時 ------------
        document.getElementById("delete").addEventListener("click", function(e) {
            e.preventDefault();

            if(confirm("本当に削除しますか？")){
                fetch(`${config.apiUrl}/customers/${id}`, {
                    method: "delete",
                })
                .then(response => response.json())
                .then(data => {
                    if(data.success){
                        alert("削除が完了しました。");
                        window.location.href = "list.html";
                    }else{
                        alert("削除に失敗しました。");
                    }
                })
                .catch((error) => console.error(error));
            }else{
                alert("中止しました。");
            }
            
            
        })
        
    </script>
    
    <!-- BootstrapのJavaScriptと依存関係のリンク -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>